# Discord 平台快速上手指南

本文档 **严格按照 `parser.py` 的解析规则** 撰写，帮助你在 Discord 上正确使用 `/nai` 与 `/nainl`。

---

## 1. 调用方式

1. **Slash 命令**：在聊天框输入 `/`，选择 `nai` 或 `nainl`。Discord slash 命令只有一个 `params` 字段，你需要在这个字段中输入 `参数名:<参数值>` 格式的文本。**重要：参数名必须使用中文**（如 `正面词条`、`负面词条`），不能使用英文（如 `prompt`、`negative_prompt`），否则插件无法识别。
2. **纯文本输入**：直接发送 `/nai 参数名:<参数值>`。语法与 QQ 完全一致（必须带尖括号，参数名必须使用中文）。
3. **图片引用**：
   - **Discord 平台统一逻辑**：无论是 Slash 命令还是纯文本命令，当你在 `params` 字段或命令中写 `底图:<是>`、`底图:<1>` 或任何非 "否" 的值时，机器人都会提示 "请发送底图/角色参考图"，并等待你在 60 秒内补发图片。**不支持在同一条消息中直接引用图片**。
   - 如果明确写 `底图:<否>` 或 `角色参考:<否>`，则跳过该功能。
   - **重要限制**：`底图` 与 `角色参考` 不能同时启用（不能同时为非 "否" 的值），否则会提示报错。
4. **白名单与限额**：账号需在白名单内且额度未耗尽，才能成功调用。额度每天 00:00 重置。

---

## 2. `/nai` 支持的字段（与 `parser.py` 完全一致）

> ⚠️ **重要提示**：Discord slash 命令只有一个 `params` 字段。你需要在 `params` 字段中输入 `参数名:<参数值>` 格式的文本，且**参数名必须使用中文**（如 `正面词条`、`负面词条`）。使用英文参数名（如 `prompt`、`negative_prompt`）会导致插件无法识别，不会有任何回复。

### 2.1 基础参数

> 💡 **布尔值参数说明**：以下参数支持 `是/否` 和 `true/false`（全小写）混用，两者等价：
> - `是否有福瑞`：`是` = `true`，`否` = `false`
> - `添加质量词`：`是` = `true`，`否` = `false`
> - `角色是否分区`：`是` = `true`，`否` = `false`
> - `是否注意原画风`：`是` = `true`，`否` = `false`
> - `底图`、`角色参考`：`是` = `true`，`否` = `false`
>
> ⚠️ **注意**：true和false务必全小写，不保证首字母大写或全大写能用

| 参数名（必须使用中文） | 必填 | 取值范围 | 说明 |
| --- | --- | --- | --- |
| `正面词条` | 是 | 任意提示词 | 缺失会报错。 |
| `负面词条` | 否 | 任意提示词 | 留空则使用 `preset_uc`（默认 Heavy）。 |
| `分辨率` | 否 | `portrait/landscape/square` ↔ `竖图/横图/方图` | 只有这三种预设，**没有自定义宽高**。 |
| `步数` | 否 | 1~28 的整数 | 超出范围会被拒绝。 |
| `指导系数` | 否 | 0~10 浮点 | 默认 5.0。 |
| `重采样系数` | 否 | 0~1 浮点 | 默认 0.0。 |
| `种子` | 否 | -1 或整数 | -1/留空表示随机。 |
| `采样器` | 否 | `k_euler、k_euler_ancestral、k_dpmpp_2s_ancestral、k_dpmpp_2m、k_dpmpp_sde、k_dpmpp_2m_sde` | 仅这些值有效。 |
| `模型` | 否 | `MODELS` 列表中的任意项 | 例：`nai-diffusion-4-5-full`。 |
| `是否有福瑞` | 否 | `true/false` 或 `是/否`（可混用） | `true`/`是` 时会在提示词前追加 `fur dataset`。 |
| `添加质量词` | 否 | `true/false` 或 `是/否`（可混用） | 控制是否附加 `quality_words`。 |
| `底图` | 否 | `是/否` 或 `true/false`（可混用，不区分大小写）或任意值 | 写任何非 "否"/`false` 的值（如 `是`、`true`、`1` 等）都会进入补图流程，机器人会提示你发送图片。写 `否`/`false` 则跳过。 |
| `底图重绘强度` | 否 | 0~1 浮点 | 默认 0.7（无论 Slash 还是纯文本）。 |
| `底图加噪强度` | 否 | 0~0.99 浮点 | 默认 0.0。 |
| `角色是否分区` | 否 | `true/false` 或 `是/否`（可混用） | 未填写时根据角色数量自动决定。 |
| `角色参考` | 否 | `是/否` 或 `true/false`（可混用，不区分大小写）或任意值 | 写任何非 "否"/`false` 的值（如 `是`、`true`、`1` 等）都会进入补图流程，机器人会提示你发送图片。写 `否`/`false` 则跳过。与底图互斥。 |
| `角色参考强度` | 否 | 0~1 浮点 | 默认 1.0。**仅在 `角色参考` 为 `是`/`true` 时有效，否则会被忽略。** |
| `是否注意原画风` | 否 | `true/false` 或 `是/否`（可混用） | 默认为 `false`/`否`。**仅在 `角色参考` 为 `是`/`true` 时有效，否则会被忽略。** |

> ⚠️ Slash 模式的 `底图` 与 `角色参考` 不能同时为 "是"，否则插件会提示错误并终止本次请求。

> ⚠️ **重要**：`角色参考强度` 和 `是否注意原画风` 这两个参数**只有在 `角色参考` 为 `是`/`true` 时才有意义**。如果 `角色参考` 为 `否`/`false` 或未填写，这两个参数会被忽略。

> ⚠️ Slash UI 若显示 `Variety+`、`噪声调度`、`SMEA/DYN`、自定义宽高等字段，请不要填写——`parser.py` 不认识这些键，提交会直接报错 "未知参数"。

### 2.2 角色参数（最多 5 个）

| 参数名（必须使用中文） | 取值 | 说明 |
| --- | --- | --- |
| `角色{i}正面词条` | 任意提示词 | 定义角色 i（1~5），**下面的参数务必与其一一对应**。 |
| `角色{i}负面词条` | 任意提示词 | 可选。 |
| `角色{i}位置` | `A1~E5` | 不写则默认 `C3`。 |

只要设置了 `角色{i}正面词条` 就视为启用该角色；索引超出 1~5 会抛错。

### 2.3 合法示例

**Slash 命令示例**（在 `params` 字段中输入）：
```
正面词条:<masterpiece, 1girl, white dress> 负面词条:<bad hands, extra fingers> 分辨率:<竖图> 步数:<24> 指导系数:<6.0> 重采样系数:<0.3> 采样器:<k_dpmpp_2m> 种子:<123456789> 是否有福瑞:<否> 添加质量词:<true> 底图:<是> 底图重绘强度:<0.65> 底图加噪强度:<0.1> 角色1正面词条:<blue eyes, short hair> 角色1负面词条:<open mouth> 角色1位置:<B2> 模型:<nai-diffusion-4-5-full>
```

**纯文本命令示例**（使用底图）：
```
/nai 正面词条:<masterpiece, 1girl, white dress> 负面词条:<bad hands, extra fingers> 分辨率:<竖图> 步数:<24> 指导系数:<6.0> 重采样系数:<0.3> 采样器:<k_dpmpp_2m> 种子:<123456789> 是否有福瑞:<否> 添加质量词:<true> 底图:<是> 底图重绘强度:<0.65> 底图加噪强度:<0.1> 角色1正面词条:<blue eyes, short hair> 角色1负面词条:<open mouth> 角色1位置:<B2> 模型:<nai-diffusion-4-5-full>
```

**纯文本命令示例**（使用角色参考）：
```
/nai 正面词条:<masterpiece, 1girl, white dress> 负面词条:<bad hands, extra fingers> 分辨率:<竖图> 步数:<24> 指导系数:<6.0> 重采样系数:<0.3> 采样器:<k_dpmpp_2m> 种子:<123456789> 是否有福瑞:<否> 添加质量词:<true> 角色参考:<是> 角色参考强度:<0.8> 是否注意原画风:<true> 角色1正面词条:<blue eyes, short hair> 角色1负面词条:<open mouth> 角色1位置:<B2> 模型:<nai-diffusion-4-5-full>
```

> 上述示例展示了两种常见用法：
> - **使用底图**：在 `params` 字段或命令中写 `底图:<是>`，发送后机器人会提示 "请发送底图"，你需要在 60 秒内补发图片。
> - **使用角色参考**：在 `params` 字段或命令中写 `角色参考:<是>`，发送后机器人会提示 "请发送角色参考图"，你需要在 60 秒内补发图片。注意 `是否注意原画风` 和 `角色参考强度` 只有在使用角色参考时才有意义。
>
> **重要**：Discord 平台不支持在同一条消息中直接引用图片，必须分两步操作（先发送命令，再发送图片）。

若只写 `/nai 正面词条:<...>` 也没问题，其余字段自动使用默认值。

---

## 3. `/nainl` 自然语言模式

- Slash：只需填写 `text`（自然语言描述），其它字段请保持默认，否则会被忽略。
- 纯文本：`/nainl 夕阳下的蒸汽朋克城市`。
- 当前实现中，**所有结构化参数都会被丢弃**，仅自然语言描述会传给 LLM，再转为 `/nai 正面词条:<...>`。因此 `/nainl` 不支持自定义步骤、采样器等；想要细节控制请改用 `/nai`。

---

## 4. 管理与帮助指令

| 指令 | 说明 |
| --- | --- |
| `/nai_whitelist_add user:<成员> nickname:<可选>` | 添加/更新白名单。 |
| `/nai_whitelist_remove user:<成员>` | 移除白名单。 |
| `/nai_limit_set user:<成员> limit:<次数>` | 调整每日额度。 |
| `/naihelp` | 输出与 `parser.py` 一致的完整模板。 |

白名单文件保存在 `AstrBot/data/plugins/astrbot_plugin_novelai_img_generation/data/discord/whitelist.json`。

---

## 5. 常见问题

- **Slash 命令没有回复**：检查是否使用了英文参数名（如 `prompt`、`negative_prompt`）。Discord slash 命令**必须使用中文参数名**（如 `正面词条`、`负面词条`），否则插件无法识别。
- **Slash 表单里的额外字段要填吗？** Discord slash 命令只有一个 `params` 字段，在这个字段中输入 `参数名:<参数值>` 格式的文本即可。
- **提示 Unknown parameter**：说明填写了未在 `_GENERAL_KEYS` 或角色键列表里的字段，或者使用了英文参数名。
- **角色提示无效**：必须为每个角色写 `角色{i}正面词条`（使用中文），位置只能是 `A1~E5`。
- **底图/角色参考引用失败**：无论是 Slash 还是纯文本模式，只要写了 `底图:<是>`、`底图:<1>` 或任何非 "否" 的值，机器人都会提示你发送图片。请在 60 秒内补发图片。**Discord 平台不支持在同一条消息中直接引用图片。**
- **想在 `/nainl` 里改步数**：目前不支持，改用 `/nai`。

遵循以上规则即可在 Discord 上稳定绘图。若有新参数加入，请先确认 `parser.py` 更新后再写入指令。祝创作顺利！
