# QQ 平台快速上手指南

---

## 1. 指令调用与图片引用

- **斜杠指令**：在聊天框直接输入 `/nai ...` 或 `/nainl ...`，无需 @ 机器人。
- **图片引用**：发送指令时可在同一条消息里附多张图。参数中写 `底图:<1>` / `角色参考:<2>` 即表示使用当前消息里第 1 / 2 张图片；编号必须是正整数。
- **白名单与额度**：若账号或群未在白名单，或当日额度耗尽，机器人会拒绝请求；额度每日 00:00 自动重置。

---

## 2. 参数语法与分词规则

1. **格式**：`/指令 参数名:<参数值>`。英文或中文冒号皆可，但值必须放在尖括号内。
2. **分隔**：不同参数之间用空格或换行，同一对尖括号中只写一个键对应的内容。
3. **校验**：`parser.py` 仅接受下表列出的键。填写未定义的键（如 `Variety+`、自定义宽高等）会立刻报错“未知参数”。
4. **兜底行为**：若整条消息没有任何 `键:<值>` 结构，系统会把全文当作 `正面词条`（`auto_positive=True`）。

---

## 3. `/nai` 支持的结构化参数

### 3.1 基础项（`_GENERAL_KEYS`）

| 参数名 | 必填 | 取值与范围 | 说明 |
| --- | --- | --- | --- |
| `正面词条` | 是 | 任意提示词 | 主提示词，缺失会抛出 `未填写提示词`。 |
| `负面词条` | 否 | 任意提示词 | 留空时使用 `config.yaml` 的 `preset_uc`。 |
| `分辨率` | 否 | `竖图 / 横图 / 方图` | 仅支持三种预设，没有自定义宽高。 |
| `步数` | 否 | 1~28 的整数 | 默认 28，超过范围会抛错。 |
| `指导系数` | 否 | 0~10 的浮点数 | 默认 5.0。 |
| `重采样系数` | 否 | 0~1 的浮点数 | 默认 0.0。 |
| `种子` | 否 | 整数或留空 | 留空/`-1` 视为随机。 |
| `采样器` | 否 | `SAMPLERS` 列表：`k_euler`、`k_euler_ancestral`、`k_dpmpp_2s_ancestral`、`k_dpmpp_2m`、`k_dpmpp_sde`、`k_dpmpp_2m_sde` | 其他值会报“采样器参数无效”。 |
| `是否有福瑞` | 否 | `是/否` 或 true/false | `True` 时在正面词条前补 `fur dataset`。 |
| `添加质量词` | 否 | `是/否` | 控制是否将 `quality_words` 追加到正面词条末尾。 |
| `底图` | 否 | 图片编号（正整数） | 指定消息中的底图。 |
| `底图重绘强度` | 否 | 0~1 浮点 | 默认 0.7。 |
| `底图加噪强度` | 否 | 0~0.99 浮点 | 默认 0.0。 |
| `角色是否分区` | 否 | `是/否` | 不写时根据角色数量自动决定（>=2 个角色自动视为 True）。 |
| `角色参考` | 否 | 图片编号 | 若同时设置了 `底图`，角色参考会被忽略。 |
| `角色参考强度` | 否 | 0~1 浮点 | 默认 1.0。 |
| `是否注意原画风` | 否 | `是/否` | `True` 时会把 `style_aware` 设为 True。 |
| `模型` | 否 | 字符串 | 仅在 `MODELS` 列表内的值才会在后续校验通过。 |

### 3.2 角色参数（最多 5 个）

`parser.py` 只识别 `角色{i}正面词条` / `角色{i}负面词条` / `角色{i}位置` 这三种键：

- 序号 i 需为 1~5，否则抛出 “角色序号仅支持1-5”。
- 只要写了 `角色{i}正面词条` 就会启用该角色；缺少正面词条会报错。
- `角色{i}位置` 默认为 `C3`，允许值为 `A1~E5`。其他值直接抛错。

### 3.3 `/nai` 示例（仅含真实键）

```
/nai 正面词条:<masterpiece, 1girl, white dress>                 # 必填
     负面词条:<bad hands, extra fingers>
     分辨率:<竖图> 步数:<24> 指导系数:<6.0> 重采样系数:<0.3>
     采样器:<k_dpmpp_2m> 种子:<123456789>
     是否有福瑞:<否> 添加质量词:<是>
     底图:<1> 底图重绘强度:<0.65> 底图加噪强度:<0.1>
     角色1正面词条:<blue eyes, short hair> 角色1负面词条:<open mouth> 角色1位置:<B2>
     角色2正面词条:<long hair, red ribbon> 角色2位置:<D3>
     角色参考:<2> 角色参考强度:<0.8>
     是否注意原画风:<是> 模型:<nai-diffusion-4-5-full>
```

---

## 4. `/nainl` 自然语言模式

当前实现流程（`main.py` + `nl_processor.py`）：

1. `/nainl 你的描述...` 只把自然语言交给 LLM 转换，内部始终回退到 `/nai 正面词条:<...>` 的形式。
2. `parser.py` 不认识 `是否自动添加质量词` 等额外键，因此 **这些参数不会生效**；若强行写，会被忽略。
3. 机器人发送 “自然语言交由 LLM 分析中，请稍后~”，成功后以默认参数生成图片。

**推荐写法**

```
/nainl 夜晚霓虹灯街道上的赛博朋克少女，背对镜头
```

若需要精确控制步数、采样器等，请改用 `/nai`，因为当前 `/nainl` 不解析额外键值。

---

## 5. 常见问题

- **提示“未知参数”**：说明填写了不在 `_GENERAL_KEYS` / 角色键范围内的字段（如 `Variety+`、`分辨率:<自定义>` 等）。
- **“分辨率参数无效”**：只允许 `竖图/横图/方图`，请勿写 `portrait` 或 `自定义`。
- **角色定位失败**：确保输入 `角色{i}位置:<A1~E5>`，且 `i` 在 1~5 范围。
- **底图编号无效**：确认当前消息中真有对应序号的图片；编号从 1 开始。
- **/nainl 想调节步骤**：目前不支持；请改用 `/nai`。

如需更多模板，可输入 `/naihelp` 查看插件内置示例（与此文保持一致）。祝创作愉快！

