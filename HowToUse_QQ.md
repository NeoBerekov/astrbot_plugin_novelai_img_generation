# QQ 平台使用指南

本指南面向在 QQ 平台与机器人互动的终端用户，介绍如何使用 `/nai` 文本指令、`/nainl` 自然语言指令以及常用管理命令。

---

## 1. 使用前准备

1. **白名单确认**
   - 管理员需先把你加入用户白名单。
   - 群聊还需将群号加入群白名单；若不在名单内，机器人会完全静默。
2. **调用方式**
   - 群聊和私聊都无需再 `@机器人`，直接输入指令即可。
   - 每次生成都会进入排队，完成后机器人会 @ 你并附带“模型 / 种子 / LLM 名称”。
3. **每日限额**
   - 每个 QQ 号都有独立的每日剩余额度，达到上限会提示“每日限额已达”。

---

## 2. `/nai` 文本指令

### 基本格式

```
/nai 参数名:<参数值> 参数名：<参数值>
```

- 支持中文、英文冒号混用，参数之间可换行或空格分隔。
- 值必须写在尖括号内；若整段内容无任何 `键:<值>` 结构，系统会提示并将全文作为正面词条。
- 附带多张图片时，可用 `底图:<1>`、`角色参考:<2>` 指定顺序编号。

### 常用参数

| 参数 | 说明 | 默认值 |
| --- | --- | --- |
| 正面词条 | 主提示词，缺少会报错 | - |
| 负面词条 | 负面提示词 | `config.yaml` → `preset_uc`，若为空则回退 Heavy 预设 |
| 分辨率 | `竖图/横图/方图` | 竖图（832×1216） |
| 步数 | 1~28 整数 | 28 |
| 指导系数 | 0~10 | 5 |
| 采样器 | `k_euler`、`k_dpmpp_2m` 等 | `k_euler_ancestral` |
| 是否有福瑞 | `是/否`，为 “是” 时自动添加 `fur dataset` 前缀 | 否 |
| 添加质量词 | `是/否`，控制是否追加质量词 | 否 |
| 角色是否分区 | `是/否`，开启后可为 1~5 名角色指定位置 | 根据角色数自动判断 |
| 角色{n}正/负面词条 | 第 n 个角色的提示词 | - |
| 角色{n}位置 | A1~E5 网格坐标 | C3 |
| 底图 / 角色参考 | 引用消息中的图片编号 | 空 |
| 模型 | 覆盖默认模型 | `config.yaml` → `default_model` |

> 若主提示词中缺少 `best quality` 与 `masterpiece`，会自动在尾部追加 `quality_words`。

### 示例

```
/nai 正面词条:<masterpiece, 1girl, white dress>
     分辨率:<横图> 步数:<24> 采样器:<k_dpmpp_2s_ancestral>
     是否有福瑞:<否> 添加质量词:<是>
```

机器人会回复“已加入生成队列”，完成后返回结果图。

---

## 3. `/nainl` 自然语言指令

```
/nainl 一个穿着蓝色连衣裙的长发少女站在樱花树下，逆光效果
```

执行流程：

1. 机器人先回复“自然语言交由 LLM 分析中，请稍后~”。
2. LLM 判断描述是否详细，选择扩写或翻译模板。
3. 模板第一步会检测是否出现疑似有出处的角色名，若有将自动：
   - 用中文检索官方英文名；
   - 用英文名查询 danbooru 标准 tag；
   - 在最终提示词中使用标准写法。
4. LLM 输出的提示词会自动补充质量词与负面词条覆盖（如配置）。
5. 队列完成后返回图片，并在提示语中标注“LLM: xxx”。

### 可选参数

- `是否自动添加质量词:<否>`：阻止 LLM 输出后追加配置中的质量词。
- 其余 `/nai` 参数同样有效，例如：

  ```
  /nainl 是否自动添加质量词:<否> 正面词条:<raw prompt>
  ```

  即使手动写了正面词条，系统仍会再次交由 LLM 统一处理。

---

## 4. 常用辅助指令

- `/naihelp`：输出详细参数模板及说明，适合复制后修改。
- `/nai插件重启`：重新读取 `config.yaml` 与白名单数据，修改配置后请执行一次。

---

## 5. 管理命令（中文）

| 命令 | 功能 |
| --- | --- |
| `/nai白名单 添加 <QQ|@成员> [昵称]` | 写入或更新用户白名单，并可即时设置昵称 |
| `/nai白名单 删除 <QQ|@成员>` | 删除用户白名单 |
| `/nai限额 设置 <QQ|@成员> <次数> [昵称]` | 修改每日限额并同步昵称 |
| `/nai群白名单 添加 [群号/本群] [群名称]` | 将当前群或指定群加入白名单 |
| `/nai群白名单 删除 [群号/本群]` | 移除群白名单 |

备注：

- 命令中可直接 `@成员` 或输入 `昵称(QQ)`，系统会自动拆分并记录昵称。
- QQ 群白名单为空时，所有群聊请求会被忽略；私聊不受影响。

---

## 6. 队列与限额机制

- 每个请求进入异步队列处理；系统会在两次请求间自动插入 3~5 秒随机延迟。
- 每日零点（系统时间）自动重置剩余额度，也可通过管理命令随时调整。
- 队列处理失败会在当前会话返回错误文本，并不会扣减额度。

---

## 7. 常见问题

1. **没有任何响应**：先确认用户与群均在白名单内，再检查是否触发每日限额。
2. **提示缺少 `/nai`**：确保指令以 `/nai` 或 `/nainl` 开头；自然语言模式同样需要带指令头。
3. **参数报错**：检查 `键:<值>` 是否写对、数值是否超范围，或根据错误提示修改。
4. **自动追加质量词不符合预期**：指令中可显式写 `添加质量词:<否>` 或在 `/nainl` 中传 `是否自动添加质量词:<否>`。
5. **角色定位失效**：确保开启 `角色是否分区:<是>`，并为每个角色指定唯一的 A1~E5 坐标。

---

祝你在 QQ 平台玩得愉快，如有问题请联系管理员或维护者。更多平台细节请参考仓库根目录的 `README.md`。
